<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¾é£Ÿæ¶ˆæ¶ˆä¹ - åƒè´§ä¸“å±é—¯å…³æ¸¸æˆ</title>
  <!-- å¼•å…¥Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- å¼•å…¥Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- è‡ªå®šä¹‰é…ç½® -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#FF6B6B',     // ä¸»è‰²è°ƒ-çŠç‘šçº¢
            secondary: '#4ECDC4',   // è¾…åŠ©è‰²-è–„è·ç»¿
            accent: '#FFD166',      // å¼ºè°ƒè‰²-æŸ æª¬é»„
            dark: '#292F36',        // æ·±è‰²
            light: '#F7F9FB',       // æµ…è‰²
          },
          fontFamily: {
            game: ['"Ma Shan Zheng"', 'cursive', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <!-- è‡ªå®šä¹‰æ ·å¼ -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .game-cell {
        @apply w-full h-full rounded-lg flex items-center justify-center cursor-pointer transition-all duration-200 shadow-md hover:scale-105 hover:shadow-lg relative;
      }
      .game-cell-selected {
        @apply scale-95 shadow-inner ring-2 ring-primary ring-offset-2 bg-primary/10;
      }
      .cell-animation {
        animation: pop 0.4s ease-in-out forwards;
      }
      .cell-swap {
        animation: swap 0.3s ease-in-out forwards;
      }
      .score-popup {
        animation: scoreUp 0.8s ease-out forwards;
      }
      .level-up {
        animation: levelUp 1s ease-out forwards;
      }
      .fade-in {
        animation: fadeIn 0.5s ease-out forwards;
      }
      .shake {
        animation: shake 0.3s ease-in-out;
      }
      .hint-highlight {
        animation: pulse 1.5s ease-in-out infinite;
      }
      .countdown-warning {
        animation: blink 1s ease-in-out infinite;
      }
      .particle {
        position: absolute;
        pointer-events: none;
        border-radius: 50%;
        z-index: 10;
        animation: particle 0.8s ease-out forwards;
      }
      /* ä¿®å¤ç½‘æ ¼å¸ƒå±€æ ¸å¿ƒæ ·å¼ */
      .game-grid-container {
        @apply relative w-full max-w-md mx-auto;
        aspect-ratio: 1/1; /* ä¸¥æ ¼ä¿æŒæ­£æ–¹å½¢ */
      }
      .game-grid {
        @apply absolute inset-0 grid grid-cols-6 gap-2;
      }
      /* å¼¹çª—å›¾ç‰‡æ ·å¼ */
      .modal-img {
        @apply w-full max-w-[250px] h-auto rounded-xl shadow-md mx-auto mb-4 object-cover;
      }
    }

    @keyframes pop {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.3); opacity: 0.9; filter: brightness(1.2); }
      100% { transform: scale(0); opacity: 0; }
    }
    
    @keyframes swap {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    @keyframes scoreUp {
      0% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(-20px); opacity: 0; }
    }
    
    @keyframes levelUp {
      0% { transform: scale(0.8); opacity: 0; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 2px rgba(255, 107, 107, 0.4); }
      50% { box-shadow: 0 0 0 6px rgba(255, 107, 107, 0.8); }
    }
    
    @keyframes blink {
      0%, 100% { color: #FF6B6B; }
      50% { color: #ff0000; }
    }
    
    @keyframes particle {
      0% { 
        transform: translate(-50%, -50%) scale(1); 
        opacity: 1; 
      }
      100% { 
        transform: translate(var(--x), var(--y)) scale(0); 
        opacity: 0; 
      }
    }
    
    /* æ»šåŠ¨æ¡ç¾åŒ– */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb {
      background: #FF6B6B;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #ff5252;
    }
  </style>
  
  <!-- å¼•å…¥ä¸­æ–‡å­—ä½“ -->
  <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-light to-secondary/20 min-h-screen font-game text-dark overflow-x-hidden">
  <!-- æ¸¸æˆåŠ è½½ç•Œé¢ -->
  <div id="loading-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50 transition-opacity duration-500">
    <div class="text-4xl md:text-6xl font-bold text-primary mb-6">ç¾é£Ÿæ¶ˆæ¶ˆä¹</div>
    <div class="w-64 h-4 bg-gray-200 rounded-full overflow-hidden">
      <div id="loading-bar" class="h-full bg-primary w-0 transition-all duration-1500"></div>
    </div>
    <p class="mt-4 text-gray-600">åŠ è½½ç¾é£Ÿä¸­...ğŸœğŸ²ğŸ—</p>
  </div>

  <!-- æ¸¸æˆè§„åˆ™å¼¹çª—ï¼ˆæ–°å¢å›¾ç‰‡ï¼‰ -->
  <div id="rules-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl fade-in">
      <div class="text-center mb-6">
        <!-- æ–°å¢å¼¹çª—å›¾ç‰‡ -->
        <img src="images/pic.jpg" alt="ç¾é£Ÿæ¶ˆæ¶ˆä¹å°é¢" class="modal-img">
        <div class="text-4xl mb-4">ğŸ“– æ¸¸æˆè§„åˆ™</div>
        <h2 class="text-2xl font-bold text-primary mb-2">ç¾é£Ÿæ¶ˆæ¶ˆä¹</h2>
      </div>
      
      <div class="space-y-4 text-left mb-8">
        <div class="flex items-start">
          <i class="fa fa-hand-pointer-o text-primary mt-1 mr-3 text-xl"></i>
          <div>
            <h4 class="font-bold">åŸºæœ¬æ“ä½œ</h4>
            <p class="text-gray-600">ç‚¹å‡»é€‰ä¸­ç¾é£Ÿå›¾æ ‡ï¼Œå†ç‚¹å‡»ç›¸é‚»å›¾æ ‡äº¤æ¢ä½ç½®ï¼Œä¸‰ä¸ªåŠä»¥ä¸Šç›¸åŒç¾é£Ÿè¿æˆä¸€çº¿å³å¯æ¶ˆé™¤</p>
          </div>
        </div>
        
        <div class="flex items-start">
          <i class="fa fa-bullseye text-primary mt-1 mr-3 text-xl"></i>
          <div>
            <h4 class="font-bold">å…³å¡ç›®æ ‡</h4>
            <p class="text-gray-600">æ¯å…³éœ€è¦è¾¾åˆ°æŒ‡å®šçš„æ¶ˆé™¤æ•°é‡å’Œåˆ†æ•°ç›®æ ‡æ‰èƒ½é€šå…³</p>
          </div>
        </div>
        
        <div class="flex items-start">
          <i class="fa fa-lightbulb-o text-primary mt-1 mr-3 text-xl"></i>
          <div>
            <h4 class="font-bold">æç¤ºåŠŸèƒ½</h4>
            <p class="text-gray-600">ç‚¹å‡»æç¤ºæŒ‰é’®å¯é«˜äº®æ˜¾ç¤ºå¯æ¶ˆé™¤ç»„åˆï¼ˆåˆå§‹3æ¬¡ï¼‰</p>
          </div>
        </div>
        
        <div class="flex items-start">
          <i class="fa fa-random text-primary mt-1 mr-3 text-xl"></i>
          <div>
            <h4 class="font-bold">æ´—ç‰ŒåŠŸèƒ½</h4>
            <p class="text-gray-600">ç‚¹å‡»æ´—ç‰ŒæŒ‰é’®é‡æ–°æ’åˆ—ç¾é£Ÿï¼ˆåˆå§‹2æ¬¡ï¼‰</p>
          </div>
        </div>
        
        <div class="flex items-start">
          <i class="fa fa-clock-o text-primary mt-1 mr-3 text-xl"></i>
          <div>
            <h4 class="font-bold">å€’è®¡æ—¶</h4>
            <p class="text-gray-600">æ¯å…³æœ‰æ—¶é—´é™åˆ¶ï¼Œéœ€åœ¨å€’è®¡æ—¶ç»“æŸå‰å®Œæˆç›®æ ‡</p>
          </div>
        </div>
        
        <div class="flex items-start">
          <i class="fa fa-cutlery text-primary mt-1 mr-3 text-xl"></i>
          <div>
            <h4 class="font-bold">å…³å¡ç‰¹è‰²</h4>
            <p class="text-gray-600">æ¯ä¸ªå…³å¡æœ‰ä¸åŒçš„ç¾é£Ÿç»„åˆå’Œéš¾åº¦ï¼Œè¶Šå¾€åæŒ‘æˆ˜è¶Šå¤§ï¼</p>
          </div>
        </div>
      </div>
      
      <button id="start-game-btn" class="w-full bg-primary hover:bg-primary/90 text-white rounded-lg px-6 py-3 shadow hover:shadow-lg transition-all text-lg font-bold">
        å¼€å§‹æ¸¸æˆ
      </button>
    </div>
  </div>

  <!-- æ¸¸æˆä¸»ç•Œé¢ -->
  <div id="game-container" class="container mx-auto px-4 py-6 max-w-5xl hidden">
    <!-- æ¸¸æˆå¤´éƒ¨ -->
    <header class="flex flex-col md:flex-row justify-between items-center mb-6 bg-white/80 backdrop-blur-sm rounded-xl p-4 shadow-lg">
      <div class="flex items-center mb-4 md:mb-0">
        <div class="text-3xl md:text-4xl font-bold text-primary mr-2">ç¾é£Ÿæ¶ˆæ¶ˆä¹</div>
        <span class="bg-accent text-dark px-3 py-1 rounded-full text-sm font-bold">åƒè´§ç‰ˆ</span>
      </div>
      
      <div class="flex flex-wrap justify-center gap-4 items-center">
        <!-- å€’è®¡æ—¶ -->
        <div class="bg-red-500 text-white rounded-lg shadow p-3 flex items-center min-w-[120px] justify-center">
          <i class="fa fa-clock-o mr-2"></i>
          <span id="countdown" class="text-xl font-bold">60</span>
          <span class="ml-1">ç§’</span>
        </div>
        
        <div class="bg-white rounded-lg shadow p-3 flex items-center">
          <i class="fa fa-star text-accent mr-2"></i>
          <span class="font-bold">åˆ†æ•°:</span>
          <span id="score" class="ml-2 text-xl font-bold text-primary">0</span>
        </div>
        
        <div class="bg-white rounded-lg shadow p-3 flex items-center">
          <i class="fa fa-map-marker text-primary mr-2"></i>
          <span class="font-bold">å…³å¡:</span>
          <span id="level" class="ml-2 text-xl font-bold text-primary">1</span>
        </div>
        
        <button id="restart-btn" class="bg-primary hover:bg-primary/90 text-white rounded-lg px-4 py-2 shadow hover:shadow-lg transition-all flex items-center">
          <i class="fa fa-refresh mr-2"></i>
          <span>é‡æ–°å¼€å§‹</span>
        </button>
      </div>
    </header>

    <!-- æ¸¸æˆå†…å®¹åŒº -->
    <div class="flex flex-col lg:flex-row gap-6">
      <!-- æ¸¸æˆé¢æ¿ -->
      <div class="flex-1 bg-white/80 backdrop-blur-sm rounded-xl p-4 shadow-lg">
        <!-- å…³å¡ç›®æ ‡ -->
        <div id="level-goal" class="mb-4 p-3 bg-primary/10 rounded-lg border-l-4 border-primary">
          <h3 class="font-bold text-lg mb-2">
            <i class="fa fa-bullseye text-primary mr-2"></i>ç¬¬<span id="goal-level">1</span>å…³ç›®æ ‡
          </h3>
          <div id="goal-text" class="text-gray-700">
            <p class="mb-1">æ¶ˆé™¤<span id="goal-count" class="text-primary font-bold">30</span>ä¸ªç¾é£Ÿï¼Œè¾¾åˆ°<span id="goal-score" class="text-primary font-bold">500</span>åˆ†</p>
            <p id="level-feature" class="text-sm text-secondary font-bold">âœ¨ ç‰¹è‰²ï¼šç»å…¸èºè›³ç²‰å¥—é¤</p>
          </div>
        </div>
        
        <!-- æ¸¸æˆç½‘æ ¼å®¹å™¨ï¼ˆä¿®å¤æ ¸å¿ƒï¼šç‹¬ç«‹å®¹å™¨ä¿æŒæ­£æ–¹å½¢ï¼‰ -->
        <div class="game-grid-container">
          <div id="game-grid" class="game-grid"></div>
        </div>
        
        <!-- æ¸¸æˆæ§åˆ¶ -->
        <div class="mt-6 flex justify-center gap-4">
          <button id="hint-btn" class="bg-secondary hover:bg-secondary/90 text-white rounded-lg px-4 py-2 shadow hover:shadow-lg transition-all flex items-center">
            <i class="fa fa-lightbulb-o mr-2"></i>
            <span>æç¤º</span>
            <span id="hint-count" class="ml-2 bg-white text-secondary rounded-full w-6 h-6 flex items-center justify-center text-sm">3</span>
          </button>
          
          <button id="shuffle-btn" class="bg-accent hover:bg-accent/90 text-dark rounded-lg px-4 py-2 shadow hover:shadow-lg transition-all flex items-center">
            <i class="fa fa-random mr-2"></i>
            <span>æ´—ç‰Œ</span>
            <span id="shuffle-count" class="ml-2 bg-white text-accent rounded-full w-6 h-6 flex items-center justify-center text-sm">2</span>
          </button>
        </div>
      </div>
      
      <!-- ä¾§è¾¹æ  -->
      <div class="lg:w-80 bg-white/80 backdrop-blur-sm rounded-xl p-4 shadow-lg">
        <!-- å…³å¡åˆ—è¡¨ -->
        <h3 class="font-bold text-xl mb-4 border-b border-gray-200 pb-2">
          <i class="fa fa-list text-primary mr-2"></i>å…³å¡åˆ—è¡¨
        </h3>
        
        <div id="levels-list" class="grid grid-cols-3 gap-2 max-h-[400px] overflow-y-auto pb-2">
          <!-- å…³å¡æŒ‰é’®ä¼šåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- å½“å‰å…³å¡ç¾é£Ÿå›¾é‰´ -->
        <h3 class="font-bold text-xl mt-6 mb-4 border-b border-gray-200 pb-2">
          <i class="fa fa-book text-primary mr-2"></i>æœ¬å…³ç¾é£Ÿ
        </h3>
        
        <div id="current-food-list" class="grid grid-cols-3 gap-2">
          <!-- å½“å‰å…³å¡ç¾é£Ÿä¼šåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- å…¨éƒ¨ç¾é£Ÿå›¾é‰´ -->
        <h3 class="font-bold text-xl mt-6 mb-4 border-b border-gray-200 pb-2">
          <i class="fa fa-book text-primary mr-2"></i>ç¾é£Ÿå¤§å…¨
        </h3>
        
        <div class="grid grid-cols-4 gap-1 max-h-[150px] overflow-y-auto">
          <div class="bg-light rounded-lg p-1 text-center">
            <div class="text-xl mb-1">ğŸœ</div>
            <div class="text-xs">èºè›³ç²‰</div>
          </div>
          <div class="bg-light rounded-lg p-1 text-center">
            <div class="text-xl mb-1">ğŸ²</div>
            <div class="text-xs">ç«é”…</div>
          </div>
          <div class="bg-light rounded-lg p-1 text-center">
            <div class="text-xl mb-1">ğŸ</div>
            <div class="text-xs">çƒ­å¹²é¢</div>
          </div>
          <div class="bg-light rounded-lg p-1 text-center">
            <div class="text-xl mb-1">ğŸ—</div>
            <div class="text-xs">é¸¡å—é¢</div>
          </div>
          <div class="bg-light rounded-lg p-1 text-center">
            <div class="text-xl mb-1">ğŸš</div>
            <div class="text-xs">ç‚’é¥­</div>
          </div>
          <div class="bg-light rounded-lg p-1 text-center">
            <div class="text-xl mb-1">ğŸ¥Ÿ</div>
            <div class="text-xs">é¥ºå­</div>
          </div>
          <div class="bg-light rounded-lg p-1 text-center">
            <div class="text-xl mb-1">ğŸ¢</div>
            <div class="text-xs">ä¸²ä¸²</div>
          </div>
          <div class="bg-light rounded-lg p-1 text-center">
            <div class="text-xl mb-1">ğŸ¡</div>
            <div class="text-xs">å…³ä¸œç…®</div>
          </div>
          <div class="bg-light rounded-lg p-1 text-center">
            <div class="text-xl mb-1">ğŸ¤</div>
            <div class="text-xs">è™¾é¥º</div>
          </div>
          <div class="bg-light rounded-lg p-1 text-center">
            <div class="text-xl mb-1">ğŸ¥˜</div>
            <div class="text-xs">ç…²ä»”é¥­</div>
          </div>
          <div class="bg-light rounded-lg p-1 text-center">
            <div class="text-xl mb-1">ğŸ›</div>
            <div class="text-xs">å’–å–±é¥­</div>
          </div>
          <div class="bg-light rounded-lg p-1 text-center">
            <div class="text-xl mb-1">ğŸ¥ </div>
            <div class="text-xs">çƒ§å–</div>
          </div>
          <div class="bg-light rounded-lg p-1 text-center">
            <div class="text-xl mb-1">ğŸ™</div>
            <div class="text-xs">é¥­å›¢</div>
          </div>
          <div class="bg-light rounded-lg p-1 text-center">
            <div class="text-xl mb-1">ğŸ¥ª</div>
            <div class="text-xs">ä¸‰æ˜æ²»</div>
          </div>
          <div class="bg-light rounded-lg p-1 text-center">
            <div class="text-xl mb-1">ğŸ¥§</div>
            <div class="text-xs">è›‹æŒ</div>
          </div>
          <div class="bg-light rounded-lg p-1 text-center">
            <div class="text-xl mb-1">ğŸ®</div>
            <div class="text-xs">å¸ƒä¸</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æ¸¸æˆåº•éƒ¨ -->
    <footer class="mt-8 text-center text-gray-600 text-sm">
      <p>ğŸœ ç¾é£Ÿæ¶ˆæ¶ˆä¹ Â© 2025 åƒè´§ï¼ˆæåŒ—ï¼‰ä¸“å±æ¸¸æˆ ğŸ²</p>
    </footer>
  </div>

  <!-- å…³å¡å®Œæˆå¼¹çª—ï¼ˆæ–°å¢å›¾ç‰‡ï¼‰ -->
  <div id="level-complete-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-40 hidden">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl level-up">
      <div class="text-center">
        <!-- æ–°å¢å¼¹çª—å›¾ç‰‡ -->
        <img src="images/pic.jpg" alt="å…³å¡å®Œæˆ" class="modal-img">
        <div class="text-6xl mb-4">ğŸ‰</div>
        <h2 class="text-3xl font-bold text-primary mb-2">å…³å¡å®Œæˆï¼</h2>
        <p class="text-xl mb-4">æ­å–œä½ å®Œæˆäº†ç¬¬<span id="completed-level">1</span>å…³</p>
        
        <div class="flex justify-between mb-6 bg-light rounded-lg p-4">
          <div>
            <p class="text-gray-600">å¾—åˆ†</p>
            <p class="text-2xl font-bold text-primary" id="final-score">0</p>
          </div>
          <div>
            <p class="text-gray-600">ç›®æ ‡</p>
            <p class="text-2xl font-bold text-secondary" id="target-score">0</p>
          </div>
          <div>
            <p class="text-gray-600">å‰©ä½™æ—¶é—´</p>
            <p class="text-2xl font-bold text-accent" id="remaining-time">0</p>
          </div>
        </div>
        
        <div class="flex gap-4 justify-center">
          <button id="play-next-btn" class="bg-primary hover:bg-primary/90 text-white rounded-lg px-6 py-3 shadow hover:shadow-lg transition-all text-lg font-bold">
            ä¸‹ä¸€å…³
          </button>
          <button id="play-again-btn" class="bg-gray-200 hover:bg-gray-300 text-dark rounded-lg px-6 py-3 shadow hover:shadow-lg transition-all text-lg font-bold">
            é‡ç©
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ¸¸æˆå¤±è´¥å¼¹çª—ï¼ˆæ–°å¢å›¾ç‰‡ï¼‰ -->
  <div id="game-over-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-40 hidden">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl fade-in">
      <div class="text-center">
        <!-- æ–°å¢å¼¹çª—å›¾ç‰‡ -->
        <img src="images/pic.jpg" alt="æ¸¸æˆç»“æŸ" class="modal-img">
        <div class="text-6xl mb-4">ğŸ˜•</div>
        <h2 class="text-3xl font-bold text-primary mb-2">æ¸¸æˆç»“æŸ</h2>
        <p class="text-xl mb-4">æœªèƒ½å®Œæˆç¬¬<span id="failed-level">1</span>å…³ç›®æ ‡</p>
        
        <div class="flex justify-between mb-6 bg-light rounded-lg p-4">
          <div>
            <p class="text-gray-600">æœ€ç»ˆå¾—åˆ†</p>
            <p class="text-2xl font-bold text-primary" id="game-over-score">0</p>
          </div>
          <div>
            <p class="text-gray-600">ç›®æ ‡åˆ†æ•°</p>
            <p class="text-2xl font-bold text-secondary" id="game-over-target">0</p>
          </div>
          <div>
            <p class="text-gray-600">æ¶ˆé™¤æ•°é‡</p>
            <p class="text-2xl font-bold text-accent" id="game-over-count">0</p>
          </div>
        </div>
        
        <div class="flex gap-4 justify-center">
          <button id="retry-btn" class="bg-primary hover:bg-primary/90 text-white rounded-lg px-6 py-3 shadow hover:shadow-lg transition-all text-lg font-bold">
            é‡æ–°å°è¯•
          </button>
          <button id="back-to-menu-btn" class="bg-gray-200 hover:bg-gray-300 text-dark rounded-lg px-6 py-3 shadow hover:shadow-lg transition-all text-lg font-bold">
            è¿”å›èœå•
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- èƒœåˆ©å¼¹çª—ï¼ˆé€šå…³ï¼‰ï¼ˆæ–°å¢å›¾ç‰‡ï¼‰ -->
  <div id="victory-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-40 hidden">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl level-up">
      <div class="text-center">
        <!-- æ–°å¢å¼¹çª—å›¾ç‰‡ -->
        <img src="images/pic.jpg" alt="æ­å–œé€šå…³" class="modal-img">
        <div class="text-6xl mb-4">ğŸ†</div>
        <h2 class="text-3xl font-bold text-primary mb-2">æ­å–œé€šå…³ï¼</h2>
        <p class="text-xl mb-4">ä½ å·²ç»å®Œæˆäº†æ‰€æœ‰å…³å¡ï¼Œæˆä¸ºç¾é£Ÿæ¶ˆæ¶ˆä¹å¤§å¸ˆï¼</p>
        
        <div class="mb-6 bg-light rounded-lg p-4">
          <p class="text-gray-600">æ€»å¾—åˆ†</p>
          <p class="text-3xl font-bold text-primary" id="total-score">0</p>
        </div>
        
        <button id="play-again-all-btn" class="bg-primary hover:bg-primary/90 text-white rounded-lg px-6 py-3 shadow hover:shadow-lg transition-all text-lg font-bold">
          é‡æ–°å¼€å§‹æ¸¸æˆ
        </button>
      </div>
    </div>
  </div>

  <script>
    // æ‰©å±•çš„ç¾é£Ÿç±»å‹åº“
    const FOOD_LIBRARY = {
      // ä¸­å¼ä¸»é£Ÿ
      noodles: [
        { icon: 'ğŸœ', name: 'èºè›³ç²‰', color: '#FF6B6B', category: 'ä¸»é£Ÿ' },
        { icon: 'ğŸ²', name: 'ç«é”…', color: '#4ECDC4', category: 'ä¸»é£Ÿ' },
        { icon: 'ğŸ', name: 'çƒ­å¹²é¢', color: '#FFD166', category: 'ä¸»é£Ÿ' },
        { icon: 'ğŸ—', name: 'é¸¡å—é¢', color: '#9370DB', category: 'ä¸»é£Ÿ' },
        { icon: 'ğŸš', name: 'ç‚’é¥­', color: '#F08080', category: 'ä¸»é£Ÿ' },
        { icon: 'ğŸ¥Ÿ', name: 'é¥ºå­', color: '#32CD32', category: 'ä¸»é£Ÿ' },
      ],
      // å°åƒé›¶é£Ÿ
      snacks: [
        { icon: 'ğŸ¢', name: 'ä¸²ä¸²', color: '#FF8C00', category: 'å°åƒ' },
        { icon: 'ğŸ¡', name: 'å…³ä¸œç…®', color: '#FF69B4', category: 'å°åƒ' },
        { icon: 'ğŸ¤', name: 'è™¾é¥º', color: '#4169E1', category: 'å°åƒ' },
        { icon: 'ğŸ¥ ', name: 'çƒ§å–', color: '#DAA520', category: 'å°åƒ' },
        { icon: 'ğŸ™', name: 'é¥­å›¢', color: '#98FB98', category: 'å°åƒ' },
        { icon: 'ğŸ¥˜', name: 'ç…²ä»”é¥­', color: '#CD853F', category: 'å°åƒ' },
      ],
      // è¥¿å¼ç¾é£Ÿ
      western: [
        { icon: 'ğŸ›', name: 'å’–å–±é¥­', color: '#FFA500', category: 'è¥¿å¼' },
        { icon: 'ğŸ¥ª', name: 'ä¸‰æ˜æ²»', color: '#8B4513', category: 'è¥¿å¼' },
        { icon: 'ğŸ•', name: 'æŠ«è¨', color: '#DC143C', category: 'è¥¿å¼' },
        { icon: 'ğŸ”', name: 'æ±‰å ¡', color: '#B8860B', category: 'è¥¿å¼' },
        { icon: 'ğŸŸ', name: 'è–¯æ¡', color: '#FFD700', category: 'è¥¿å¼' },
        { icon: 'ğŸŒ­', name: 'çƒ­ç‹—', color: '#FF4500', category: 'è¥¿å¼' },
      ],
      // ç”œç‚¹é¥®å“
      desserts: [
        { icon: 'ğŸ¥§', name: 'è›‹æŒ', color: '#FFB6C1', category: 'ç”œç‚¹' },
        { icon: 'ğŸ®', name: 'å¸ƒä¸', color: '#E6E6FA', category: 'ç”œç‚¹' },
        { icon: 'ğŸ°', name: 'è›‹ç³•', color: '#FFC0CB', category: 'ç”œç‚¹' },
        { icon: 'ğŸ§', name: 'å†°æ·‡æ·‹', color: '#ADD8E6', category: 'ç”œç‚¹' },
        { icon: 'ğŸµ', name: 'å¥¶èŒ¶', color: '#D2B48C', category: 'ç”œç‚¹' },
        { icon: 'ğŸ¥¤', name: 'æ±½æ°´', color: '#00BFFF', category: 'ç”œç‚¹' },
      ]
    };

    // æ¸¸æˆé…ç½® - æ¯ä¸ªå…³å¡æœ‰ç‹¬ç‰¹çš„ç¾é£Ÿç»„åˆ
    const GAME_CONFIG = {
      gridSize: 6,          // ç½‘æ ¼å¤§å°ï¼ˆå›ºå®š6x6ï¼‰
      levels: [
        // ç¬¬1å…³ - ç»å…¸èºè›³ç²‰å¥—é¤
        { 
          goalCount: 30, 
          goalScore: 500, 
          timeLimit: 60,
          foodCategories: ['noodles'],
          foodCount: 4,
          feature: 'ç»å…¸èºè›³ç²‰å¥—é¤'
        },
        // ç¬¬2å…³ - ç‰¹è‰²å°åƒ
        { 
          goalCount: 35, 
          goalScore: 700, 
          timeLimit: 65,
          foodCategories: ['noodles', 'snacks'],
          foodCount: 5,
          feature: 'å—æ–¹ç‰¹è‰²å°åƒ'
        },
        // ç¬¬3å…³ - ä¸­è¥¿ç»“åˆ
        { 
          goalCount: 40, 
          goalScore: 900, 
          timeLimit: 70,
          foodCategories: ['noodles', 'western'],
          foodCount: 5,
          feature: 'ä¸­è¥¿ç¾é£Ÿç»“åˆ'
        },
        // ç¬¬4å…³ - å°åƒç››å®´
        { 
          goalCount: 45, 
          goalScore: 1100, 
          timeLimit: 70,
          foodCategories: ['snacks'],
          foodCount: 6,
          feature: 'å°åƒè¡—ç››å®´'
        },
        // ç¬¬5å…³ - ç”œå“æ—¶é—´
        { 
          goalCount: 50, 
          goalScore: 1300, 
          timeLimit: 75,
          foodCategories: ['desserts'],
          foodCount: 5,
          feature: 'ç”œèœœç”œå“æ—¶é—´'
        },
        // ç¬¬6å…³ - ç¯çƒç¾é£Ÿ
        { 
          goalCount: 55, 
          goalScore: 1500, 
          timeLimit: 75,
          foodCategories: ['western', 'desserts'],
          foodCount: 6,
          feature: 'ç¯çƒç¾é£Ÿä¹‹æ—…'
        },
        // ç¬¬7å…³ - å…¨èƒ½æŒ‘æˆ˜
        { 
          goalCount: 60, 
          goalScore: 1800, 
          timeLimit: 80,
          foodCategories: ['noodles', 'snacks', 'western'],
          foodCount: 6,
          feature: 'ä¸­å¼å…¨èƒ½æŒ‘æˆ˜'
        },
        // ç¬¬8å…³ - åƒè´§å¤©å ‚
        { 
          goalCount: 70, 
          goalScore: 2200, 
          timeLimit: 80,
          foodCategories: ['noodles', 'snacks', 'desserts'],
          foodCount: 6,
          feature: 'åƒè´§çš„å¤©å ‚'
        },
        // ç¬¬9å…³ - ç»ˆææ··æ­
        { 
          goalCount: 80, 
          goalScore: 2600, 
          timeLimit: 85,
          foodCategories: ['noodles', 'snacks', 'western', 'desserts'],
          foodCount: 6,
          feature: 'ç»ˆæç¾é£Ÿæ··æ­'
        },
        // ç¬¬10å…³ - ç¾é£Ÿå¤§å¸ˆ
        { 
          goalCount: 90, 
          goalScore: 3000, 
          timeLimit: 90,
          foodCategories: ['noodles', 'snacks', 'western', 'desserts'],
          foodCount: 8,
          feature: 'ç¾é£Ÿå¤§å¸ˆç»ˆææŒ‘æˆ˜'
        },
      ],
      basePoints: 10,       // åŸºç¡€åˆ†æ•°
      hintCount: 3,         // åˆå§‹æç¤ºæ¬¡æ•°
      shuffleCount: 2       // åˆå§‹æ´—ç‰Œæ¬¡æ•°
    };

    // æ¸¸æˆçŠ¶æ€
    let gameState = {
      grid: [],             // æ¸¸æˆç½‘æ ¼æ•°æ®ï¼ˆå§‹ç»ˆä¿æŒ6x6ï¼‰
      selectedCell: null,   // é€‰ä¸­çš„æ ¼å­
      score: 0,             // å½“å‰åˆ†æ•°
      level: 1,             // å½“å‰å…³å¡
      eliminatedCount: 0,   // å·²æ¶ˆé™¤æ•°é‡
      hintCount: GAME_CONFIG.hintCount,
      shuffleCount: GAME_CONFIG.shuffleCount,
      isAnimating: false,   // æ˜¯å¦æ­£åœ¨åŠ¨ç”»ä¸­
      unlockedLevels: 1,    // å·²è§£é”å…³å¡
      countdown: 0,         // å½“å‰å€’è®¡æ—¶
      countdownTimer: null, // å€’è®¡æ—¶å®šæ—¶å™¨
      gamePaused: false,    // æ¸¸æˆæ˜¯å¦æš‚åœ
      currentFoodTypes: []  // å½“å‰å…³å¡å¯ç”¨çš„ç¾é£Ÿç±»å‹
    };

    // DOM å…ƒç´ 
    const elements = {
      loadingScreen: document.getElementById('loading-screen'),
      loadingBar: document.getElementById('loading-bar'),
      gameContainer: document.getElementById('game-container'),
      gameGrid: document.getElementById('game-grid'),
      scoreDisplay: document.getElementById('score'),
      levelDisplay: document.getElementById('level'),
      goalLevel: document.getElementById('goal-level'),
      goalCount: document.getElementById('goal-count'),
      goalScore: document.getElementById('goal-score'),
      levelFeature: document.getElementById('level-feature'),
      hintCount: document.getElementById('hint-count'),
      shuffleCount: document.getElementById('shuffle-count'),
      restartBtn: document.getElementById('restart-btn'),
      hintBtn: document.getElementById('hint-btn'),
      shuffleBtn: document.getElementById('shuffle-btn'),
      levelsList: document.getElementById('levels-list'),
      currentFoodList: document.getElementById('current-food-list'),
      levelCompleteModal: document.getElementById('level-complete-modal'),
      gameOverModal: document.getElementById('game-over-modal'),
      victoryModal: document.getElementById('victory-modal'),
      completedLevel: document.getElementById('completed-level'),
      finalScore: document.getElementById('final-score'),
      targetScore: document.getElementById('target-score'),
      remainingTime: document.getElementById('remaining-time'),
      playNextBtn: document.getElementById('play-next-btn'),
      playAgainBtn: document.getElementById('play-again-btn'),
      failedLevel: document.getElementById('failed-level'),
      gameOverScore: document.getElementById('game-over-score'),
      gameOverTarget: document.getElementById('game-over-target'),
      gameOverCount: document.getElementById('game-over-count'),
      retryBtn: document.getElementById('retry-btn'),
      backToMenuBtn: document.getElementById('back-to-menu-btn'),
      totalScore: document.getElementById('total-score'),
      playAgainAllBtn: document.getElementById('play-again-all-btn'),
      rulesModal: document.getElementById('rules-modal'),
      startGameBtn: document.getElementById('start-game-btn'),
      countdown: document.getElementById('countdown')
    };

    // åˆ›å»ºç²’å­æ•ˆæœ
    function createParticles(x, y, color, count = 10) {
      for (let i = 0; i < count; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        
        // éšæœºç²’å­å±æ€§
        const size = Math.random() * 8 + 4;
        const angle = Math.random() * Math.PI * 2;
        const distance = Math.random() * 40 + 20;
        
        // è®¾ç½®ç²’å­æ ·å¼
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.backgroundColor = color;
        particle.style.left = `${x}px`;
        particle.style.top = `${y}px`;
        particle.style.zIndex = '100'; // æå‡å±‚çº§ä½†ä¸å½±å“å¸ƒå±€
        
        // è®¾ç½®ç²’å­è¿åŠ¨è½¨è¿¹
        particle.style.setProperty('--x', `${Math.cos(angle) * distance}px`);
        particle.style.setProperty('--y', `${Math.sin(angle) * distance}px`);
        
        document.body.appendChild(particle);
        
        // ç§»é™¤ç²’å­
        setTimeout(() => {
          particle.remove();
        }, 800);
      }
    }

    // è·å–å½“å‰å…³å¡çš„ç¾é£Ÿç±»å‹
    function getCurrentLevelFoodTypes() {
      const levelConfig = GAME_CONFIG.levels[gameState.level - 1];
      let allFoods = [];
      
      // æ”¶é›†æŒ‡å®šåˆ†ç±»çš„æ‰€æœ‰ç¾é£Ÿ
      levelConfig.foodCategories.forEach(category => {
        allFoods = allFoods.concat(FOOD_LIBRARY[category]);
      });
      
      // éšæœºé€‰æ‹©æŒ‡å®šæ•°é‡çš„ç¾é£Ÿ
      const shuffled = [...allFoods].sort(() => 0.5 - Math.random());
      const selectedFoods = shuffled.slice(0, levelConfig.foodCount);
      
      gameState.currentFoodTypes = selectedFoods;
      return selectedFoods;
    }

    // æ¸²æŸ“å½“å‰å…³å¡çš„ç¾é£Ÿåˆ—è¡¨
    function renderCurrentFoodList() {
      elements.currentFoodList.innerHTML = '';
      
      gameState.currentFoodTypes.forEach(food => {
        const foodItem = document.createElement('div');
        foodItem.className = 'bg-light rounded-lg p-2 text-center';
        foodItem.innerHTML = `
          <div class="text-2xl mb-1" style="color: ${food.color}">${food.icon}</div>
          <div class="text-xs font-bold">${food.name}</div>
        `;
        elements.currentFoodList.appendChild(foodItem);
      });
    }

    // åˆå§‹åŒ–åŠ è½½ç•Œé¢
    function initLoading() {
      // æ¨¡æ‹ŸåŠ è½½è¿›åº¦
      let progress = 0;
      const loadingInterval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress >= 100) {
          progress = 100;
          clearInterval(loadingInterval);
          
          // åŠ è½½å®Œæˆï¼Œæ˜¾ç¤ºè§„åˆ™å¼¹çª—
          setTimeout(() => {
            elements.loadingScreen.classList.add('opacity-0');
            setTimeout(() => {
              elements.loadingScreen.classList.add('hidden');
              elements.rulesModal.classList.remove('hidden');
            }, 500);
          }, 500);
        }
        elements.loadingBar.style.width = `${progress}%`;
      }, 100);
    }

    // åˆå§‹åŒ–æ¸¸æˆç½‘æ ¼ï¼ˆç¡®ä¿å§‹ç»ˆ6x6ï¼‰
    function initGrid() {
      // è·å–å½“å‰å…³å¡çš„ç¾é£Ÿç±»å‹
      const foodTypes = getCurrentLevelFoodTypes();
      
      const grid = [];
      // å¼ºåˆ¶å¡«å……6x6ç½‘æ ¼ï¼Œç¡®ä¿æ²¡æœ‰ç©ºè¡Œ
      for (let row = 0; row < GAME_CONFIG.gridSize; row++) {
        grid[row] = [];
        for (let col = 0; col < GAME_CONFIG.gridSize; col++) {
          const randomType = foodTypes[
            Math.floor(Math.random() * foodTypes.length)
          ];
          grid[row][col] = {
            type: randomType,
            row,
            col,
            element: null
          };
        }
      }
      
      // ç¡®ä¿åˆå§‹ç½‘æ ¼æœ‰å¯æ¶ˆé™¤çš„ç»„åˆ
      let attempts = 0;
      while (!hasValidMoves(grid) && attempts < 10) {
        reshuffleGrid(grid);
        attempts++;
      }
      
      gameState.grid = grid;
      renderGrid();
      renderCurrentFoodList();
    }

    // æ¸²æŸ“æ¸¸æˆç½‘æ ¼ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶æ¸²æŸ“6x6å®Œæ•´ç½‘æ ¼ï¼‰
    function renderGrid() {
      // æ¸…ç©ºç½‘æ ¼ä½†ä¿æŒå®¹å™¨ç»“æ„
      elements.gameGrid.innerHTML = '';
      
      // å¼ºåˆ¶æ¸²æŸ“6è¡Œ6åˆ—ï¼Œç¡®ä¿å¸ƒå±€å®Œæ•´
      for (let row = 0; row < GAME_CONFIG.gridSize; row++) {
        for (let col = 0; col < GAME_CONFIG.gridSize; col++) {
          const cell = gameState.grid[row][col];
          const cellElement = document.createElement('div');
          cellElement.className = 'game-cell';
          cellElement.style.backgroundColor = `${cell.type.color}10`;
          cellElement.innerHTML = `<span class="text-2xl" style="color: ${cell.type.color}">${cell.type.icon}</span>`;
          cellElement.dataset.row = row;
          cellElement.dataset.col = col;
          
          // ç‚¹å‡»äº‹ä»¶
          cellElement.addEventListener('click', () => handleCellClick(row, col));
          
          elements.gameGrid.appendChild(cellElement);
          cell.element = cellElement;
        }
      }
    }

    // å¤„ç†æ ¼å­ç‚¹å‡»
    function handleCellClick(row, col) {
      if (gameState.isAnimating || gameState.gamePaused) return;
      
      const cell = gameState.grid[row][col];
      
      // å¦‚æœå·²ç»é€‰ä¸­äº†ä¸€ä¸ªæ ¼å­
      if (gameState.selectedCell) {
        const selectedRow = gameState.selectedCell.row;
        const selectedCol = gameState.selectedCell.col;
        
        // å–æ¶ˆé€‰ä¸­åŒä¸€ä¸ªæ ¼å­
        if (selectedRow === row && selectedCol === col) {
          gameState.selectedCell.element.classList.remove('game-cell-selected');
          gameState.selectedCell = null;
          return;
        }
        
        // æ£€æŸ¥æ˜¯å¦ç›¸é‚»
        if (isAdjacent(selectedRow, selectedCol, row, col)) {
          // æ·»åŠ äº¤æ¢åŠ¨ç”»
          gameState.selectedCell.element.classList.add('cell-swap');
          cell.element.classList.add('cell-swap');
          
          // äº¤æ¢æ ¼å­
          swapCells(selectedRow, selectedCol, row, col);
          
          // æ£€æŸ¥æ˜¯å¦å½¢æˆæ¶ˆé™¤ç»„åˆ
          const matches = findMatches();
          if (matches.length > 0) {
            // æœ‰æ¶ˆé™¤ç»„åˆï¼Œä¿æŒäº¤æ¢
            setTimeout(() => {
              gameState.selectedCell.element.classList.remove('game-cell-selected', 'cell-swap');
              cell.element.classList.remove('cell-swap');
              gameState.selectedCell = null;
              processMatches(matches);
            }, 300);
          } else {
            // æ²¡æœ‰æ¶ˆé™¤ç»„åˆï¼Œäº¤æ¢å›æ¥
            setTimeout(() => {
              swapCells(row, col, selectedRow, selectedCol);
              gameState.selectedCell.element.classList.remove('game-cell-selected', 'cell-swap');
              cell.element.classList.remove('cell-swap');
              gameState.selectedCell = null;
              // æŠ–åŠ¨æ•ˆæœè¡¨ç¤ºæ— æ•ˆç§»åŠ¨
              cell.element.classList.add('shake');
              gameState.selectedCell.element.classList.add('shake');
              setTimeout(() => {
                cell.element.classList.remove('shake');
                gameState.selectedCell.element.classList.remove('shake');
              }, 300);
            }, 300);
          }
        } else {
          // ä¸ç›¸é‚»ï¼Œåˆ‡æ¢é€‰ä¸­çŠ¶æ€
          gameState.selectedCell.element.classList.remove('game-cell-selected');
          cell.element.classList.add('game-cell-selected');
          gameState.selectedCell = cell;
        }
      } else {
        // é€‰ä¸­ç¬¬ä¸€ä¸ªæ ¼å­
        cell.element.classList.add('game-cell-selected');
        gameState.selectedCell = cell;
      }
    }

    // æ£€æŸ¥æ˜¯å¦ç›¸é‚»
    function isAdjacent(row1, col1, row2, col2) {
      const rowDiff = Math.abs(row1 - row2);
      const colDiff = Math.abs(col1 - col2);
      return (rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1);
    }

    // äº¤æ¢ä¸¤ä¸ªæ ¼å­
    function swapCells(row1, col1, row2, col2) {
      const grid = gameState.grid;
      const temp = grid[row1][col1];
      
      // æ›´æ–°DOMï¼ˆåªæ›´æ–°å†…å®¹ï¼Œä¸ç ´åç½‘æ ¼ç»“æ„ï¼‰
      const tempIcon = grid[row1][col1].element.innerHTML;
      grid[row1][col1].element.innerHTML = grid[row2][col2].element.innerHTML;
      grid[row2][col2].element.innerHTML = tempIcon;
      
      // æ›´æ–°èƒŒæ™¯è‰²
      grid[row1][col1].element.style.backgroundColor = `${grid[row2][col2].type.color}10`;
      grid[row2][col2].element.style.backgroundColor = `${temp.type.color}10`;
      
      // æ›´æ–°æ•°æ®
      grid[row1][col1] = grid[row2][col2];
      grid[row2][col2] = temp;
      
      // æ›´æ–°è¡Œåˆ—ä¿¡æ¯
      grid[row1][col1].row = row1;
      grid[row1][col1].col = col1;
      grid[row2][col2].row = row2;
      grid[row2][col2].col = col2;
    }

    // æŸ¥æ‰¾æ‰€æœ‰å¯æ¶ˆé™¤çš„ç»„åˆ
    function findMatches() {
      const grid = gameState.grid;
      const matches = [];
      const matched = new Set();
      
      // æ£€æŸ¥æ°´å¹³åŒ¹é…
      for (let row = 0; row < GAME_CONFIG.gridSize; row++) {
        for (let col = 0; col < GAME_CONFIG.gridSize - 2; col++) {
          const current = grid[row][col];
          if (current && current.type.icon === grid[row][col+1].type.icon && 
              current.type.icon === grid[row][col+2].type.icon) {
            
            // æ‰¾åˆ°åŒ¹é…ï¼Œæ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰©å±•
            let matchLength = 3;
            while (col + matchLength < GAME_CONFIG.gridSize && 
                   grid[row][col + matchLength] &&
                   grid[row][col + matchLength].type.icon === current.type.icon) {
              matchLength++;
            }
            
            // è®°å½•åŒ¹é…çš„æ ¼å­
            const match = [];
            for (let i = 0; i < matchLength; i++) {
              const key = `${row}-${col+i}`;
              if (!matched.has(key)) {
                matched.add(key);
                match.push(grid[row][col+i]);
              }
            }
            
            if (match.length >= 3) {
              matches.push(match);
            }
            
            col += matchLength - 1;
          }
        }
      }
      
      // æ£€æŸ¥å‚ç›´åŒ¹é…
      for (let col = 0; col < GAME_CONFIG.gridSize; col++) {
        for (let row = 0; row < GAME_CONFIG.gridSize - 2; row++) {
          const current = grid[row][col];
          if (current && current.type.icon === grid[row+1][col].type.icon && 
              current.type.icon === grid[row+2][col].type.icon) {
            
            // æ‰¾åˆ°åŒ¹é…ï¼Œæ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰©å±•
            let matchLength = 3;
            while (row + matchLength < GAME_CONFIG.gridSize && 
                   grid[row + matchLength] &&
                   grid[row + matchLength][col] &&
                   grid[row + matchLength][col].type.icon === current.type.icon) {
              matchLength++;
            }
            
            // è®°å½•åŒ¹é…çš„æ ¼å­
            const match = [];
            for (let i = 0; i < matchLength; i++) {
              const key = `${row+i}-${col}`;
              if (!matched.has(key)) {
                matched.add(key);
                match.push(grid[row+i][col]);
              }
            }
            
            if (match.length >= 3) {
              matches.push(match);
            }
            
            row += matchLength - 1;
          }
        }
      }
      
      return matches;
    }

    // å¤„ç†æ¶ˆé™¤åŒ¹é…ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šé‡æ„å¡«å……é€»è¾‘ï¼Œä¸ç ´åç½‘æ ¼ç»“æ„ï¼‰
    function processMatches(matches) {
      gameState.isAnimating = true;
      pauseGame(true);
      
      // è®¡ç®—æ€»åˆ†
      let totalPoints = 0;
      matches.forEach(match => {
        const matchPoints = GAME_CONFIG.basePoints * match.length;
        totalPoints += matchPoints;
        
        // æ·»åŠ æ¶ˆé™¤åŠ¨ç”»å’Œç²’å­æ•ˆæœ
        match.forEach(cell => {
          cell.element.classList.add('cell-animation');
          // åˆ›å»ºç²’å­æ•ˆæœ
          const rect = cell.element.getBoundingClientRect();
          const x = rect.left + rect.width / 2;
          const y = rect.top + rect.height / 2;
          createParticles(x, y, cell.type.color);
        });
      });
      
      // æ›´æ–°åˆ†æ•°å’Œæ¶ˆé™¤è®¡æ•°
      gameState.score += totalPoints;
      gameState.eliminatedCount += matches.flat().length;
      
      // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
      updateScoreDisplay();
      
      // æ˜¾ç¤ºåˆ†æ•°å¼¹çª—
      showScorePopup(totalPoints);
      
      // ç«‹å³æ£€æŸ¥å…³å¡å®Œæˆ
      const levelCompleted = checkLevelCompletionImmediate();
      if (levelCompleted) {
        gameState.isAnimating = false;
        pauseGame(false);
        return;
      }
      
      // ç­‰å¾…åŠ¨ç”»å®Œæˆåé‡æ„ç½‘æ ¼ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šç›´æ¥é‡æ„è€ŒéåŠ¨æ€ä¸‹è½ï¼‰
      setTimeout(() => {
        // 1. æ”¶é›†æ‰€æœ‰éç©ºå•å…ƒæ ¼
        const nonEmptyCells = [];
        for (let row = 0; row < GAME_CONFIG.gridSize; row++) {
          for (let col = 0; col < GAME_CONFIG.gridSize; col++) {
            if (!matches.flat().some(cell => cell.row === row && cell.col === col)) {
              nonEmptyCells.push(gameState.grid[row][col]);
            }
          }
        }
        
        // 2. é‡æ„6x6ç½‘æ ¼ï¼ˆå…³é”®ä¿®å¤ï¼šç¡®ä¿å¡«æ»¡æ‰€æœ‰æ ¼å­ï¼‰
        const foodTypes = gameState.currentFoodTypes;
        let cellIndex = 0;
        
        for (let col = 0; col < GAME_CONFIG.gridSize; col++) {
          // å…ˆå¡«å……åˆ—çš„åº•éƒ¨
          const columnCells = [];
          
          // æ”¶é›†å½“å‰åˆ—çš„éç©ºå•å…ƒæ ¼
          for (let row = 0; row < GAME_CONFIG.gridSize; row++) {
            if (!matches.flat().some(cell => cell.row === row && cell.col === col)) {
              columnCells.push(gameState.grid[row][col]);
            }
          }
          
          // å¡«å……ç©ºç™½ä½ç½®ï¼ˆä»ä¸‹å¾€ä¸Šï¼‰
          for (let row = GAME_CONFIG.gridSize - 1; row >= 0; row--) {
            if (columnCells.length > 0) {
              const cell = columnCells.pop();
              gameState.grid[row][col] = {
                type: cell.type,
                row,
                col,
                element: null
              };
            } else {
              // å¡«å……æ–°çš„éšæœºç¾é£Ÿ
              gameState.grid[row][col] = {
                type: foodTypes[Math.floor(Math.random() * foodTypes.length)],
                row,
                col,
                element: null
              };
            }
          }
        }
        
        // 3. é‡æ–°æ¸²æŸ“å®Œæ•´ç½‘æ ¼ï¼Œç¡®ä¿6x6ç»“æ„
        renderGrid();
        
        // 4. æ£€æŸ¥è¿é”æ¶ˆé™¤
        setTimeout(() => {
          const newMatches = findMatches();
          if (newMatches.length > 0) {
            // è¿é”æ¶ˆé™¤
            processMatches(newMatches);
          } else {
            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æœ‰æ•ˆç§»åŠ¨
            if (!hasValidMoves(gameState.grid)) {
              // æ²¡æœ‰æœ‰æ•ˆç§»åŠ¨ï¼Œè‡ªåŠ¨æ´—ç‰Œ
              if (gameState.shuffleCount > 0) {
                showShuffleNotification();
                reshuffleGrid(gameState.grid);
                renderGrid();
                gameState.shuffleCount--;
                elements.shuffleCount.textContent = gameState.shuffleCount;
              } else {
                showGameOver();
              }
            }
            
            gameState.isAnimating = false;
            pauseGame(false);
          }
        }, 300);
        
      }, 400);
    }

    // ç«‹å³æ£€æŸ¥å…³å¡å®ŒæˆçŠ¶æ€
    function checkLevelCompletionImmediate() {
      const currentLevelConfig = GAME_CONFIG.levels[gameState.level - 1];
      
      console.log('å…³å¡æ£€æŸ¥:', {
        level: gameState.level,
        eliminatedCount: gameState.eliminatedCount,
        goalCount: currentLevelConfig.goalCount,
        score: gameState.score,
        goalScore: currentLevelConfig.goalScore,
        timeLeft: gameState.countdown
      });
      
      // ä¿®å¤ï¼šåŒæ—¶æ»¡è¶³æ¶ˆé™¤æ•°é‡å’Œåˆ†æ•°ç›®æ ‡ï¼Œä¸”è¿˜æœ‰å‰©ä½™æ—¶é—´
      if (gameState.eliminatedCount >= currentLevelConfig.goalCount && 
          gameState.score >= currentLevelConfig.goalScore &&
          gameState.countdown > 0) {
        
        // å…³å¡å®Œæˆ
        pauseGame(true);
        
        if (gameState.level < GAME_CONFIG.levels.length) {
          // æ›´æ–°è§£é”å…³å¡
          if (gameState.level >= gameState.unlockedLevels) {
            gameState.unlockedLevels = gameState.level + 1;
          }
          
          // æ˜¾ç¤ºå…³å¡å®Œæˆå¼¹çª—
          elements.remainingTime.textContent = gameState.countdown;
          elements.completedLevel.textContent = gameState.level;
          elements.finalScore.textContent = gameState.score;
          elements.targetScore.textContent = currentLevelConfig.goalScore;
          elements.levelCompleteModal.classList.remove('hidden');
        } else {
          // æ‰€æœ‰å…³å¡å®Œæˆ
          elements.totalScore.textContent = gameState.score;
          elements.victoryModal.classList.remove('hidden');
        }
        
        // æ¸…é™¤å€’è®¡æ—¶
        if (gameState.countdownTimer) {
          clearInterval(gameState.countdownTimer);
        }
        
        return true; // å…³å¡å·²å®Œæˆ
      }
      
      return false; // å…³å¡æœªå®Œæˆ
    }

    // æ˜¾ç¤ºåˆ†æ•°å¼¹çª—
    function showScorePopup(points) {
      const popup = document.createElement('div');
      popup.className = 'score-popup fixed text-primary font-bold text-xl';
      popup.textContent = `+${points}`;
      
      // å®šä½åˆ°æ¸¸æˆç½‘æ ¼ä¸­å¿ƒ
      const gridRect = elements.gameGrid.getBoundingClientRect();
      popup.style.left = `${gridRect.left + gridRect.width/2}px`;
      popup.style.top = `${gridRect.top + gridRect.height/2}px`;
      popup.style.transform = 'translate(-50%, -50%)';
      popup.style.pointerEvents = 'none';
      popup.style.zIndex = '10';
      
      document.body.appendChild(popup);
      
      // ç§»é™¤å¼¹çª—
      setTimeout(() => {
        popup.remove();
      }, 800);
    }

    // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆç§»åŠ¨
    function hasValidMoves(grid) {
      // å¤åˆ¶ç½‘æ ¼è¿›è¡Œæ£€æŸ¥
      const tempGrid = JSON.parse(JSON.stringify(grid));
      
      // æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„äº¤æ¢
      for (let row = 0; row < GAME_CONFIG.gridSize; row++) {
        for (let col = 0; col < GAME_CONFIG.gridSize; col++) {
          if (!tempGrid[row][col]) continue;
          
          // æ£€æŸ¥å³ä¾§äº¤æ¢
          if (col < GAME_CONFIG.gridSize - 1 && tempGrid[row][col+1]) {
            // äº¤æ¢
            const temp = tempGrid[row][col];
            tempGrid[row][col] = tempGrid[row][col+1];
            tempGrid[row][col+1] = temp;
            
            // æ£€æŸ¥åŒ¹é…
            if (findMatchesInGrid(tempGrid).length > 0) {
              return true;
            }
            
            // äº¤æ¢å›æ¥
            const temp2 = tempGrid[row][col];
            tempGrid[row][col] = tempGrid[row][col+1];
            tempGrid[row][col+1] = temp2;
          }
          
          // æ£€æŸ¥ä¸‹æ–¹äº¤æ¢
          if (row < GAME_CONFIG.gridSize - 1 && tempGrid[row+1][col]) {
            // äº¤æ¢
            const temp = tempGrid[row][col];
            tempGrid[row][col] = tempGrid[row+1][col];
            tempGrid[row+1][col] = temp;
            
            // æ£€æŸ¥åŒ¹é…
            if (findMatchesInGrid(tempGrid).length > 0) {
              return true;
            }
            
            // äº¤æ¢å›æ¥
            const temp2 = tempGrid[row][col];
            tempGrid[row][col] = tempGrid[row+1][col];
            tempGrid[row+1][col] = temp2;
          }
        }
      }
      
      return false;
    }

    // åœ¨æŒ‡å®šç½‘æ ¼ä¸­æŸ¥æ‰¾åŒ¹é…
    function findMatchesInGrid(grid) {
      const matches = [];
      const matched = new Set();
      
      // æ£€æŸ¥æ°´å¹³åŒ¹é…
      for (let row = 0; row < GAME_CONFIG.gridSize; row++) {
        for (let col = 0; col < GAME_CONFIG.gridSize - 2; col++) {
          if (grid[row][col] && 
              grid[row][col].type.icon === grid[row][col+1].type.icon && 
              grid[row][col].type.icon === grid[row][col+2].type.icon) {
            matches.push([grid[row][col], grid[row][col+1], grid[row][col+2]]);
          }
        }
      }
      
      // æ£€æŸ¥å‚ç›´åŒ¹é…
      for (let col = 0; col < GAME_CONFIG.gridSize; col++) {
        for (let row = 0; row < GAME_CONFIG.gridSize - 2; row++) {
          if (grid[row][col] && 
              grid[row][col].type.icon === grid[row+1][col].type.icon && 
              grid[row][col].type.icon === grid[row+2][col].type.icon) {
            matches.push([grid[row][col], grid[row+1][col], grid[row+2][col]]);
          }
        }
      }
      
      return matches;
    }

    // é‡æ–°æ´—ç‰Œç½‘æ ¼ï¼ˆç¡®ä¿6x6å®Œæ•´ï¼‰
    function reshuffleGrid(grid) {
      const foodTypes = gameState.currentFoodTypes;
      
      // é‡æ–°éšæœºå¡«å……æ•´ä¸ªç½‘æ ¼
      for (let row = 0; row < GAME_CONFIG.gridSize; row++) {
        for (let col = 0; col < GAME_CONFIG.gridSize; col++) {
          grid[row][col] = {
            type: foodTypes[Math.floor(Math.random() * foodTypes.length)],
            row,
            col,
            element: null
          };
        }
      }
      
      return grid;
    }

    // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
    function updateScoreDisplay() {
      elements.scoreDisplay.textContent = gameState.score;
      elements.levelDisplay.textContent = gameState.level;
      elements.goalLevel.textContent = gameState.level;
      
      const currentLevelConfig = GAME_CONFIG.levels[gameState.level - 1];
      elements.goalCount.textContent = `${currentLevelConfig.goalCount} (å·²æ¶ˆé™¤: ${gameState.eliminatedCount})`;
      elements.goalScore.textContent = `${currentLevelConfig.goalScore} (å½“å‰: ${gameState.score})`;
      elements.levelFeature.textContent = `âœ¨ ç‰¹è‰²ï¼š${currentLevelConfig.feature}`;
      
      // æ›´æ–°å€’è®¡æ—¶æ ·å¼
      if (gameState.countdown <= 10) {
        elements.countdown.classList.add('countdown-warning');
      } else {
        elements.countdown.classList.remove('countdown-warning');
      }
      elements.countdown.textContent = gameState.countdown;
    }

    // åˆå§‹åŒ–å…³å¡åˆ—è¡¨
    function initLevelsList() {
      elements.levelsList.innerHTML = '';
      
      for (let i = 1; i <= GAME_CONFIG.levels.length; i++) {
        const levelBtn = document.createElement('button');
        levelBtn.className = `game-cell ${i === gameState.level ? 'bg-primary text-white' : 
                               i <= gameState.unlockedLevels ? 'bg-secondary text-white' : 
                               'bg-gray-200 text-gray-400 cursor-not-allowed'}`;
        levelBtn.textContent = i;
        
        if (i <= gameState.unlockedLevels) {
          levelBtn.addEventListener('click', () => {
            if (i !== gameState.level && !gameState.isAnimating && !gameState.gamePaused) {
              gameState.level = i;
              resetGame(false);
            }
          });
        } else {
          levelBtn.disabled = true;
        }
        
        elements.levelsList.appendChild(levelBtn);
      }
    }

    // åˆå§‹åŒ–å€’è®¡æ—¶
    function initCountdown() {
      // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
      if (gameState.countdownTimer) {
        clearInterval(gameState.countdownTimer);
      }
      
      // è®¾ç½®æ–°çš„å€’è®¡æ—¶
      const currentLevelConfig = GAME_CONFIG.levels[gameState.level - 1];
      gameState.countdown = currentLevelConfig.timeLimit;
      
      // æ›´æ–°æ˜¾ç¤º
      elements.countdown.textContent = gameState.countdown;
      
      // å¯åŠ¨å€’è®¡æ—¶
      gameState.countdownTimer = setInterval(() => {
        if (!gameState.gamePaused) {
          gameState.countdown--;
          elements.countdown.textContent = gameState.countdown;
          
          // å€’è®¡æ—¶è­¦å‘Šæ ·å¼
          if (gameState.countdown <= 10) {
            elements.countdown.classList.add('countdown-warning');
          }
          
          // å€’è®¡æ—¶ç»“æŸ
          if (gameState.countdown <= 0) {
            clearInterval(gameState.countdownTimer);
            // æ£€æŸ¥æ˜¯å¦å®Œæˆç›®æ ‡
            const currentLevelConfig = GAME_CONFIG.levels[gameState.level - 1];
            if (gameState.eliminatedCount >= currentLevelConfig.goalCount && 
                gameState.score >= currentLevelConfig.goalScore) {
              // åˆšå¥½å®Œæˆç›®æ ‡
              checkLevelCompletionImmediate();
            } else {
              // æœªå®Œæˆç›®æ ‡
              showGameOver();
            }
          }
        }
      }, 1000);
    }

    // æš‚åœ/æ¢å¤æ¸¸æˆ
    function pauseGame(pause) {
      gameState.gamePaused = pause;
    }

    // é‡ç½®æ¸¸æˆ
    function resetGame(fullReset = true) {
      // æš‚åœå½“å‰å€’è®¡æ—¶
      if (gameState.countdownTimer) {
        clearInterval(gameState.countdownTimer);
      }
      
      if (fullReset) {
        gameState.score = 0;
        gameState.eliminatedCount = 0;
        gameState.hintCount = GAME_CONFIG.hintCount;
        gameState.shuffleCount = GAME_CONFIG.shuffleCount;
        elements.hintCount.textContent = gameState.hintCount;
        elements.shuffleCount.textContent = gameState.shuffleCount;
      } else {
        gameState.eliminatedCount = 0;
      }
      
      gameState.selectedCell = null;
      gameState.gamePaused = false;
      initGrid(); // é‡æ–°åˆå§‹åŒ–å®Œæ•´ç½‘æ ¼
      initCountdown();
      updateScoreDisplay();
      initLevelsList();
    }

    // æ˜¾ç¤ºæ¸¸æˆç»“æŸå¼¹çª—
    function showGameOver() {
      pauseGame(true);
      elements.failedLevel.textContent = gameState.level;
      elements.gameOverScore.textContent = gameState.score;
      elements.gameOverCount.textContent = `${gameState.eliminatedCount}`;
      
      const currentLevelConfig = GAME_CONFIG.levels[gameState.level - 1];
      elements.gameOverTarget.textContent = currentLevelConfig.goalScore;
      
      elements.gameOverModal.classList.remove('hidden');
    }

    // æ˜¾ç¤ºæ´—ç‰Œé€šçŸ¥
    function showShuffleNotification() {
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 right-4 bg-accent text-dark px-4 py-2 rounded-lg shadow-lg score-popup z-50';
      notification.textContent = `ğŸ”€ æ²¡æœ‰æœ‰æ•ˆç§»åŠ¨ï¼Œè‡ªåŠ¨æ´—ç‰Œ (å‰©ä½™æ¬¡æ•°: ${gameState.shuffleCount-1})`;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 2000);
    }

    // æ˜¾ç¤ºæç¤º
    function showHint() {
      if (gameState.hintCount <= 0 || gameState.isAnimating || gameState.gamePaused) return;
      
      gameState.hintCount--;
      elements.hintCount.textContent = gameState.hintCount;
      
      // æŸ¥æ‰¾å¯äº¤æ¢çš„ä½ç½®
      const grid = gameState.grid;
      let hintCells = null;
      
      // æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„äº¤æ¢
      outerLoop:
      for (let row = 0; row < GAME_CONFIG.gridSize; row++) {
        for (let col = 0; col < GAME_CONFIG.gridSize; col++) {
          if (!grid[row][col]) continue;
          
          // æ£€æŸ¥å³ä¾§äº¤æ¢
          if (col < GAME_CONFIG.gridSize - 1 && grid[row][col+1]) {
            // ä¸´æ—¶ä¿å­˜åŸå§‹æ•°æ®
            const original1 = { ...grid[row][col].type };
            const original2 = { ...grid[row][col+1].type };
            
            // ä¸´æ—¶äº¤æ¢ç”¨äºæ£€æŸ¥
            grid[row][col].type = original2;
            grid[row][col+1].type = original1;
            
            // æ£€æŸ¥åŒ¹é…
            if (findMatches().length > 0) {
              hintCells = [
                grid[row][col],
                grid[row][col+1]
              ];
              // æ¢å¤åŸå§‹æ•°æ®
              grid[row][col].type = original1;
              grid[row][col+1].type = original2;
              break outerLoop;
            }
            
            // æ¢å¤åŸå§‹æ•°æ®
            grid[row][col].type = original1;
            grid[row][col+1].type = original2;
          }
          
          // æ£€æŸ¥ä¸‹æ–¹äº¤æ¢
          if (row < GAME_CONFIG.gridSize - 1 && grid[row+1][col]) {
            // ä¸´æ—¶ä¿å­˜åŸå§‹æ•°æ®
            const original1 = { ...grid[row][col].type };
            const original2 = { ...grid[row+1][col].type };
            
            // ä¸´æ—¶äº¤æ¢ç”¨äºæ£€æŸ¥
            grid[row][col].type = original2;
            grid[row+1][col].type = original1;
            
            // æ£€æŸ¥åŒ¹é…
            if (findMatches().length > 0) {
              hintCells = [
                grid[row][col],
                grid[row+1][col]
              ];
              // æ¢å¤åŸå§‹æ•°æ®
              grid[row][col].type = original1;
              grid[row+1][col].type = original2;
              break outerLoop;
            }
            
            // æ¢å¤åŸå§‹æ•°æ®
            grid[row][col].type = original1;
            grid[row+1][col].type = original2;
          }
        }
      }
      
      // é«˜äº®æç¤ºçš„æ ¼å­
      if (hintCells) {
        hintCells.forEach(cell => {
          cell.element.classList.add('hint-highlight');
          
          setTimeout(() => {
            cell.element.classList.remove('hint-highlight');
          }, 3000);
        });
        
        // æ’­æ”¾æç¤ºéŸ³æ•ˆ
        try {
          const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-interface-hint-notification-911.mp3');
          audio.volume = 0.5;
          audio.play();
        } catch (e) {
          console.log('æç¤ºéŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e);
        }
      } else {
        // æ²¡æœ‰æ‰¾åˆ°å¯æ¶ˆé™¤çš„ç»„åˆ
        showShuffleNotification();
        handleShuffle();
      }
    }

    // æ´—ç‰ŒæŒ‰é’®å¤„ç†
    function handleShuffle() {
      if (gameState.shuffleCount <= 0 || gameState.isAnimating || gameState.gamePaused) return;
      
      showShuffleNotification();
      reshuffleGrid(gameState.grid);
      renderGrid(); // é‡æ–°æ¸²æŸ“å®Œæ•´ç½‘æ ¼
      gameState.shuffleCount--;
      elements.shuffleCount.textContent = gameState.shuffleCount;
      
      // æ’­æ”¾æ´—ç‰ŒéŸ³æ•ˆ
      try {
        const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-fast-small-sweep-transition-166.mp3');
        audio.volume = 0.5;
        audio.play();
      } catch (e) {
        console.log('æ´—ç‰ŒéŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e);
      }
    }

    // äº‹ä»¶ç›‘å¬
    function initEventListeners() {
      // å¼€å§‹æ¸¸æˆæŒ‰é’®ï¼ˆè§„åˆ™å¼¹çª—ï¼‰
      elements.startGameBtn.addEventListener('click', () => {
        elements.rulesModal.classList.add('hidden');
        elements.gameContainer.classList.remove('hidden');
                resetGame(true);
      });
      
      // é‡æ–°å¼€å§‹æŒ‰é’®
      elements.restartBtn.addEventListener('click', () => {
        if (!gameState.isAnimating) {
          resetGame(true);
        }
      });
      
      // æç¤ºæŒ‰é’®
      elements.hintBtn.addEventListener('click', showHint);
      
      // æ´—ç‰ŒæŒ‰é’®
      elements.shuffleBtn.addEventListener('click', handleShuffle);
      
      // ä¸‹ä¸€å…³æŒ‰é’®
      elements.playNextBtn.addEventListener('click', () => {
        elements.levelCompleteModal.classList.add('hidden');
        gameState.level++;
        resetGame(true);
        pauseGame(false);
      });
      
      // é‡ç©å½“å‰å…³æŒ‰é’®
      elements.playAgainBtn.addEventListener('click', () => {
        elements.levelCompleteModal.classList.add('hidden');
        resetGame(false);
        pauseGame(false);
      });
      
      // é‡è¯•æŒ‰é’®
      elements.retryBtn.addEventListener('click', () => {
        elements.gameOverModal.classList.add('hidden');
        resetGame(false);
        pauseGame(false);
      });
      
      // è¿”å›èœå•æŒ‰é’®
      elements.backToMenuBtn.addEventListener('click', () => {
        elements.gameOverModal.classList.add('hidden');
        gameState.level = 1;
        resetGame(true);
        pauseGame(false);
      });
      
      // é‡æ–°å¼€å§‹æ‰€æœ‰å…³å¡æŒ‰é’®
      elements.playAgainAllBtn.addEventListener('click', () => {
        elements.victoryModal.classList.add('hidden');
        gameState.level = 1;
        gameState.unlockedLevels = 1;
        resetGame(true);
        pauseGame(false);
      });
      
      // å“åº”å¼è°ƒæ•´ï¼ˆå¼ºåˆ¶é‡æ¸²æŸ“å®Œæ•´ç½‘æ ¼ï¼‰
      window.addEventListener('resize', () => {
        if (!gameState.isAnimating && !gameState.gamePaused) {
          renderGrid(); // çª—å£è°ƒæ•´åå¼ºåˆ¶é‡æ¸²æŸ“ï¼Œé¿å…å¸ƒå±€é”™ä½
        }
      });
      
      // é˜²æ­¢é¡µé¢åˆ·æ–°/å…³é—­æ—¶è¯¯æ“ä½œ
      window.addEventListener('beforeunload', (e) => {
        if (gameState.score > 0) {
          e.preventDefault();
          e.returnValue = 'ä½ ç¡®å®šè¦ç¦»å¼€å—ï¼Ÿå½“å‰æ¸¸æˆè¿›åº¦å°†ä¼šä¸¢å¤±ï¼';
          return e.returnValue;
        }
      });
      
      // é”®ç›˜å¿«æ·é”®
      document.addEventListener('keydown', (e) => {
        if (e.key === 'h' || e.key === 'H') {
          showHint(); // Hé”®æç¤º
        } else if (e.key === 's' || e.key === 'S') {
          handleShuffle(); // Sé”®æ´—ç‰Œ
        } else if (e.key === 'r' || e.key === 'R') {
          resetGame(true); // Ré”®é‡æ–°å¼€å§‹
        }
      });
    }

    // æ˜¾ç¤ºåˆ†æ•°å¼¹çª—
    function showScorePopup(points) {
      const popup = document.createElement('div');
      popup.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-primary/90 text-white px-6 py-3 rounded-lg shadow-xl score-popup z-30';
      popup.textContent = `+${points} åˆ†ï¼`;
      document.body.appendChild(popup);
      
      // è‡ªåŠ¨ç§»é™¤å¼¹çª—
      setTimeout(() => {
        popup.remove();
      }, 800);
    }

    // æ£€æŸ¥å…³å¡å®Œæˆï¼ˆç‹¬ç«‹å‡½æ•°ï¼‰
    function checkLevelCompletionImmediate() {
      const currentLevelConfig = GAME_CONFIG.levels[gameState.level - 1];
      
      // æ£€æŸ¥æ˜¯å¦æ»¡è¶³æ‰€æœ‰æ¡ä»¶
      const isCountMet = gameState.eliminatedCount >= currentLevelConfig.goalCount;
      const isScoreMet = gameState.score >= currentLevelConfig.goalScore;
      const hasTimeLeft = gameState.countdown > 0;
      
      if (isCountMet && isScoreMet && hasTimeLeft) {
        // æ˜¾ç¤ºå…³å¡å®Œæˆå¼¹çª—
        elements.completedLevel.textContent = gameState.level;
        elements.finalScore.textContent = gameState.score;
        elements.targetScore.textContent = currentLevelConfig.goalScore;
        elements.remainingTime.textContent = gameState.countdown;
        elements.levelCompleteModal.classList.remove('hidden');
        
        // æ’­æ”¾é€šå…³éŸ³æ•ˆ
        try {
          const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3');
          audio.volume = 0.7;
          audio.play();
        } catch (e) {
          console.log('é€šå…³éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e);
        }
        
        // æ¸…é™¤å€’è®¡æ—¶
        if (gameState.countdownTimer) {
          clearInterval(gameState.countdownTimer);
        }
        
        return true;
      }
      
      return false;
    }

    // åˆå§‹åŒ–æ¸¸æˆ
    function initGame() {
      initLoading();
      initLevelsList();
      initEventListeners();
      
      // é¢„åŠ è½½éŸ³æ•ˆï¼ˆæå‡ä½“éªŒï¼‰
      const audioFiles = [
        'https://assets.mixkit.co/sfx/preview/mixkit-interface-hint-notification-911.mp3',
        'https://assets.mixkit.co/sfx/preview/mixkit-fast-small-sweep-transition-166.mp3',
        'https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3'
      ];
      
      audioFiles.forEach(url => {
        const audio = new Audio(url);
        audio.load(); // é¢„åŠ è½½
      });
      
      // åˆå§‹åŒ–ç½‘æ ¼ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMåŠ è½½å®Œæˆï¼‰
      setTimeout(() => {
        initGrid();
        updateScoreDisplay();
      }, 1000);
    }

    // å¯åŠ¨æ¸¸æˆ
    document.addEventListener('DOMContentLoaded', initGame);
  </script>
</body>
</html>